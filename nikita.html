<html>
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/semantic.min.css">
<style>
        body { font-family: "Open Sans"; margin: 40px;}

        .row {
  width: 100%;
  margin: 0 auto;
}
.block1 {
  width: 550px;
  float: left
}
.block2 {
  width: 550px;
  float: right
}
        #display-el {
  display:none;
  visibility: hidden;
}
</style>
</head>
<body>
<h1> Showing imdb rated <span id="span1"></span> movies of  <span id="span2"></span> , for  <span id="span3"> </span>  </h1>
<br>
<div> 
    <select id="select-el" onchange="handleGenreFilterSelection(this.value)" >
        <option value="All">Filter by Genre</option>
        <option id="action" value="Action">Action</option>
        <option id="adventure" value="Adventure">Adventure</option>
        <option id="animation" value="Animation">Animation</option>
        <option id="comedy" value="Comedy">Comedy</option>
        <option id="crime" value="Crime">Crime</option>
        <option id="drama" value="Drama">Drama</option>
        <option id="horror" value="Horror">Horror</option>
        <option id="romance" value="Romance">Romance</option>
        <option id="thriller" value="Thriller">Thriller</option>
        <option id="documentary" value="Documentary">Documentary</option>
    </select>
    </div>

    <div id="scatter-plot"></div>
    <div class = "row" id = "group">
    <div class = "block1">
    <h3>Year</h3>

        <input  type="radio"  id="All" value="All" name = "year" checked="checked" onClick = "handleYearSelection(this.id)"> All
        <input type="radio" id="2010" value="2010" name = "year" onClick = "handleYearSelection(this.id)"> 2010
        <input type="radio"  id="2011" value="2011" name = "year" onClick = "handleYearSelection(this.id)"> 2011
        <input  type="radio" id="2012" value="2012" name = "year" onClick = "handleYearSelection(this.id)"> 2012
        <input  type="radio"  id="2013" value="2013" name = "year" onClick = "handleYearSelection(this.id)"> 2013
    </div>
    <div class = "block2">

    <h3>Top Ratings</h3>

        <input  type="radio"  id="top5" value="Top-5" name = "rate"  onClick = "handleRating(this.id, this.value)"> Top-5
        <input type="radio"  id="top15" value="Top-15" name = "rate" onClick = "handleRating(this.id, this.value)"> Top-15
        <input  type="radio" id="top25" value="Top-25" name = "rate" onClick = "handleRating(this.id, this.value)"> Top-25
        <input  type="radio"  id="top50" value="Top-50" name = "rate" checked="checked" onClick = "handleRating(this.id, this.value)"> Top-50
    </div>
    </div>
    <script>


    var margin = { top: 20, bottom: 30, left: 40, right: 20 };
    var width = 1000;
    var height = 600;
    padding = 70;
    var options = ["Action", "Adventure", "Animation", "Comedy", "Crime", "Drama", "Horror", "Romance", "Thriller", "Documentary"];

    var xScale = d3.scale.log().range([0, width]).nice();
    var yScale = d3.scale.log().range([height, 0]).nice();
    var colorScale = d3.scale.category10();
    var ratedOption = "top50";
    var chosenGenre = "All";
    var chosenYear = "All";
    var chosenRate = "Top-50"
    var yearArray;
    var result=[]; var xDomain; var yDomain;
    var initialData;
        var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
        var yAxis = d3.svg.axis().scale(yScale).orient("left");    
    d3.csv("movie_budgets/movie_budget_all.csv", function(error, data){
        if(error){
            throw error;
        }
        data = data.filter(function(d) {return (d.imdbRating != "N/A" && d.imdbRating != "None");});
        result = sortDataByRating(data);   
        initialData = sortDataByRating(data);  
        var ratedOption = "top50";
        xDomain = d3.extent(initialData[ratedOption], function(d){ return parseInt(d.Budget.substr(1).replace(',', '')); })
        yDomain = d3.extent(initialData[ratedOption], function(d){ return parseInt(d["Worldwide Gross"].substr(1).replace(',', '')); });
                displayDataPoints(initialData[ratedOption]);


    });
    var svg = d3.select("#scatter-plot").append("svg")
        .attr("width", width+margin.left+margin.right)
        .attr("height", height+margin.top+margin.bottom)
        .append("g")
        .attr("transform", "translate("+margin.left+","+margin.top+")");

    function sortDataByRating(values){
        values.sort(function(a, b){
            return parseFloat(a.imdbRating) - parseFloat(b.imdbRating);
        });
        var filtered = values.filter(function(d){ 
            return parseInt(d.Budget.substr(1).replace(',', '')) != 0
            && parseInt(d["Worldwide Gross"].substr(1).replace(',', '')) !=0; 
        });
        
        return { top5: filtered.slice(0, 5), top15: filtered.slice(0, 15), top25: filtered.slice(0, 25), top50: filtered.slice(0, 50), top500: filtered.slice(0,values.length-1) };
    }






     function displayDataPoints(data){
        //create the scale for the size of the data points in the scatter plot
        
        // xScale = d3.scale.log().domain(xDomain).range([0, (width )]);
        // yScale = d3.scale.log().domain(yDomain).range([height, 0]);
        //     var sizeScale = d3.scale.linear()
        //         .domain(d3.extent(data, function(d){ return parseFloat(d.imdbRating); }))
        //         .range([5, 14]);

            //set the domain of the x and y axis

        d3.selectAll(".axis text").remove();
        d3.selectAll(".axis line").remove();
        d3.selectAll(".data-point").remove();
        var sizeScale = d3.scale.linear()
                .domain(d3.extent(data, function(d){ return parseFloat(d.imdbRating); }))
                .range([5, 18]);


        xDomain = d3.extent(data, function(d){ return parseInt(d.Budget.substr(1).replace(',', '')); })
        yDomain = d3.extent(data, function(d){ return parseInt(d["Worldwide Gross"].substr(1).replace(',', '')); });

        var incrementX = parseInt(xDomain[0]/5);
        var incrementY = parseInt(yDomain[0]/5);

        xScale.domain([xDomain[0]-incrementX, xDomain[1]]);
        yScale.domain([yDomain[0]-incrementY, yDomain[1]]);

            
            svg.append("g")
               .attr("class", "axis")
               .attr("transform", "translate(0,"+height+")")
               .call(xAxis)
               .append("text")
               .attr("class", "label")
               .attr("x", width)
               .attr("y", -6)
               .style("text-anchor", "end")
               .text("Budget($)");

            svg.append("g")
               .attr("class", "axis")
               .call(yAxis)
               .append("text")
               .attr("class", "label")
               .attr("transform", "rotate(-90)")
               .attr("y", 6)
               .style("text-anchor", "end")
               .text("Worldwide Gross($)");

            var dataPoints = svg.selectAll(".point")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "point")
            .attr("r", function(d){  return sizeScale(parseFloat(d.imdbRating)); })
            .attr("cx", xScale(xDomain[0] - incrementX))
            .attr("cy", yScale(yDomain[0] - incrementY))
            .style("fill", function(d) { return colorScale(((d.Genre).split(","))[0]); } )
            .style("stroke", "black")
            .style("opacity", 0.9);

             dataPoints.transition()
        .duration(1000)
        .attr("cx", function(d){ return xScale(parseInt(d.Budget.substr(1).replace(',', ''))); })
        .attr("cy", function(d){ return yScale(parseInt(d["Worldwide Gross"].substr(1).replace(',', ''))); });


    }

    function filterDataByGenre(genre, data){
        return data.filter(function(d){
            return (d.Genre).split(",").includes(genre);
        });
    }

    function handleGenreFilterSelection(genre){
        chosenGenre = genre;
        document.getElementById('span2').innerHTML="<font color='red'>"+chosenGenre +"</font>" +  " genre";

        if(chosenYear != "All") {
            if(chosenGenre == "All") {
            svg.selectAll(".point").data([]).exit().remove();

                 displayDataPoints(initialData[ratedOption]);  
            return;
            }
            var filteredData = filterDataByGenre(genre, yearArray);
            var sData = sortDataByRating(filteredData);
            svg.selectAll(".point").data([]).exit().remove();

        displayDataPoints(sData[ratedOption])
            return;
        }
        var inputData = initialData["top500"];
    
        if(genre == "All") {
                    svg.selectAll(".point").data([]).exit().remove();

            displayDataPoints(initialData[ratedOption]);  
            return;
        }

        var filteredData = filterDataByGenre(genre, inputData);
        var sortedData = sortDataByRating(filteredData);
            svg.selectAll(".point").data([]).exit().remove();

        displayDataPoints(sortedData[ratedOption]);      
    }


    function handleYearSelection(value){
        chosenYear = value;
                document.getElementById('span3').innerHTML="<font color='red'>"+chosenYear +"</font>"+ " Year";

        var path = "movie_budgets/movie_budget_" + value + ".csv";
        d3.csv(path, function(error, data){
            if(error){
                throw error;
            }
            data = data.filter(function(d) {return (d.imdbRating != "N/A" && d.imdbRating != "None");});

           var yearData = sortDataByRating(data);
           yearArray = data;
            var yData = yearData[ratedOption];
            svg.selectAll(".point").data([]).exit().remove();

            if(chosenGenre=="All"){

                displayDataPoints(yData);
                return; 

            }
            yData = yearData["top500"];
            yearArray = yData;
            yData = filterDataByGenre(chosenGenre, yData);
            displayDataPoints(yData); 
        });
    }

    function handleRating(id, value) {
        ratedOption = id;
        chosenRate = value;
        document.getElementById('span1').innerHTML="<font color='red'>" + chosenRate + "</font>";
        handleGenreFilterSelection(chosenGenre);

    }

document.getElementById('span3').innerHTML="<font color='red'>"+"all" + "</font>" + " years";
document.getElementById('span2').innerHTML="<font color='red'>"+"all" + "</font>" + " genres";
document.getElementById('span1').innerHTML="<font color='red'>" + chosenRate + "</font>";

</script>
</body>
</html>