<!DOCTYPE html>
<meta charset="utf-8">
	<head>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>


<!--Visualization 1 -->
	<h1>A Decreasing Trend in Return Rate</h1>
	<div id ="buttons"  style="width: 550px; margin: auto">
	<button class="button" onclick="logRate()" style="float: right;" >Log Rate</button>
	<button class="button" onclick="rate()"  style="float: right;">Raw Rate</button>
	</div>
	<div id ="lineChart" > </div>

<!--Visualziation 2  -->
	<div class="container-fluid">
	<div class="row">
	<div class="col-xs-12">
	<h1> Showing imdb rated <span id="span1"></span> movies of  <span id="span2"></span> , for  <span id="span3"> </span>  </h1>
	                </div>
	            </div>
	 <br>
	    <div>
	        <select id="select-el" onchange="handleGenreFilterSelection(this.value)" >
	            <option value="All">Filter by Genre</option>
	            <option id="action" value="Action">Action</option>
	            <option id="adventure" value="Adventure">Adventure</option>
	            <option id="animation" value="Animation">Animation</option>
	            <option id="comedy" value="Comedy">Comedy</option>
	            <option id="crime" value="Crime">Crime</option>
	            <option id="drama" value="Drama">Drama</option>
	            <option id="horror" value="Horror">Horror</option>
	            <option id="romance" value="Romance">Romance</option>
	            <option id="thriller" value="Thriller">Thriller</option>
	            <option id="documentary" value="Documentary">Documentary</option>
	    </select>
	</div>


	 <div class="row">
	        <div class="col-xs-12">
	    <svg id="scatter-plot" viewBox="0 0 800 400" preserveAspectRatio="xMidYMid" style="display:inline-block;"> </svg>
	    <div id = "detail" class = "detail">Click on the circle for more details </div> <br><br>
	    <div id="label" class = "label">Label </div>
	    </div>
	</div>

  <div class="row">
	     <div class="col-xs-6">
	      <!--Body content-->
	      <h3>Year</h3>
	            <input  type="radio"  id="All" value="All" name = "year" checked="checked" onClick = "handleYearSelection(this.id)"> All
	            <input type="radio" id="2010" value="2010" name = "year" onClick = "handleYearSelection(this.id)"> 2010
	            <input type="radio"  id="2011" value="2011" name = "year" onClick = "handleYearSelection(this.id)"> 2011
	            <input  type="radio" id="2012" value="2012" name = "year" onClick = "handleYearSelection(this.id)"> 2012
	            <input  type="radio"  id="2013" value="2013" name = "year" onClick = "handleYearSelection(this.id)"> 2013
	      </div>


  <div class="col-xs-6 col-xs-offset-2 text-right ">

	     <h3>Top Ratings</h3>
	            <input  type="radio"  id="top5" value="Top-5" name = "rate"  onClick = "handleRating(this.id, this.value)"> Top-5
	            <input type="radio"  id="top15" value="Top-15" name = "rate" onClick = "handleRating(this.id, this.value)"> Top-15
	            <input  type="radio" id="top25" value="Top-25" name = "rate" onClick = "handleRating(this.id, this.value)"> Top-25
	            <input  type="radio"  id="top50" value="Top-50" name = "rate" checked="checked" onClick = "handleRating(this.id, this.value)"> Top-50
	        </div>
	    </div>
	</div>

<script>
//=========================Visualization 1===============================
// code source: https://bl.ocks.org/mbostock/3883245
// data source http://www.the-numbers.com/movie/budgets/all

	var margin = {top: 20, right: 20, bottom: 30, left: 50},
    	width = 960 - margin.left - margin.right,
   	 	height = 500 - margin.top - margin.bottom;

	var xScale = d3.scale.linear()
    .range([0, width]);

	var yScale = d3.scale.linear()
   	 	.range([height, 0]);

	var xAxis = d3.svg.axis()
   	 	.scale(xScale)
   	 	.orient("bottom")
		.tickFormat(d3.format(".s"));

	var yAxis = d3.svg.axis()
    	.scale(yScale)
    	.orient("left");

	var svg2 = d3.select("#lineChart").append("svg")
		.attr("viewBox", '0 0 1200 800')
 	   	.attr("preserveAspectRatio", "xMinYMin meet")
		.classed("svg-content", true)
  		.append("g")
    	.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
		;

	//helper function
	function linearRegression(y,x){
			var lr = {};
			var n = y.length;
			var sum_x = 0;
			var sum_y = 0;
			var sum_xy = 0;
			var sum_xx = 0;
			var sum_yy = 0;

			for (var i = 0; i < y.length; i++) {
				sum_x += x[i];
				sum_y += y[i];
				sum_xy += (x[i]*y[i]);
				sum_xx += (x[i]*x[i]);
				sum_yy += (y[i]*y[i]);
			}

			lr.slope = (n * sum_xy - sum_x * sum_y) / (n*sum_xx - sum_x * sum_x);
			lr.intercept = (sum_y - lr.slope * sum_x)/n;
			lr.r2 = Math.pow((n*sum_xy - sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2);

			return lr;
	}


	d3.csv("meanAllMonYear.csv", function(error, data) {
 		data.forEach(function(d) {
  			d.year = +d.year;
  			d.logYearMeanRate = +d.logYearMeanRate; });

	//map the domain
 	xScale.domain(d3.extent(data, function(d) { return d.year; }));
  yScale.domain(d3.extent(data, function(d) { return d.logYearMeanRate; }));

	var valueLine = d3.svg.line().interpolate("basis")
		.x(function(d) { return xScale(d.year); })
		.y(function(d) { return yScale(d.logYearMeanRate); });


	//draw x axis
  	svg2.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
		.call(xAxis);

	//format x ticks
	var formatxAxis = d3.format('s');

	//draw y axis
  	svg2.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Return Rate");

	//draw the path
  	svg2.append("path")
    	.attr("class", "line")
	  	.attr("d", valueLine(data));


	var xval = data.map(function (d) { return d.year; });
	var yval = data.map(function (d) { return d.logYearMeanRate; });

	lr = linearRegression(yval, xval);
	//feed in the x and y from the dataset

	max = d3.max(xval);

	x1= 0;
	x2= max;
	y1= lr.intercept;
	y2= lr.slope*max + lr.intercept;

	var trendData = [{"x": x1, "y": y1}, {"x": x2, "y": y2}];

	var regressionLine = d3.svg.line()
		    	.x(function(d) { return xScale(d.x); })
		    	.y(function(d) { return yScale(d.y); });


	//draw the path
	svg2.append("path")
		.attr("class", "line")
  		.attr("d", regressionLine(trendData))
		.attr("id", "regressionLine")
		.style("stroke-dasharray", ("20, 3"))
		.style("stroke", "#b2df8a")//green color
		.style("stroke-width", "7")
		.style("opacity", "0.5");
	});


	function rate() {
    	// Get the data again
    	d3.csv("meanAllMonYear.csv", function(error, data) {
       		data.forEach(function(d) {
	    	d.year = +d.year;
	    	d.yearMean = +d.yearMean;
	    });

    	// Scale the range of the data again
    xScale.domain(d3.extent(data, function(d) { return d.year; }));
	 	yScale.domain(d3.extent(data, function(d) { return d.yearMean; }));

		var valueLine2 = d3.svg.line().interpolate("basis")
			.x(function(d) { return xScale(d.year); })
			.y(function(d) { return yScale(d.yearMean); });

		var regressionLine2 = d3.svg.line()
    		.x(function(d) { return xScale(d.x); })
    		.y(function(d) { return yScale(d.y); });

		var xval = data.map(function (d) { return d.year; });
		var yval = data.map(function (d) { return d.yearMean; });


		lr = linearRegression(yval, xval);

		max = d3.max(xval);

		x1= 0;
		x2= max;
		y1= lr.intercept;
		y2= lr.slope*max + lr.intercept;

		var trendData = [{"x": x1, "y": y1}, {"x": x2, "y": y2}];

	// Select the section we want to apply our changes to
		var svg2 = d3.select("#lineChart").transition();

	// Make the changes
	svg2.select(".line")   // change the line
			.duration(750)
			.attr("d", valueLine2(data));
	svg2.select("#regressionLine") //change the regression line
			.duration(750)
			.attr("d", regressionLine2(trendData))
			.attr("id", "regressionLine2");
	svg2.select(".x.axis") // change the x axis
			.duration(750)
			.call(xAxis);
	svg2.select(".y.axis") // change the y axis
			.duration(750)
			.call(yAxis);

    });
}

	function logRate(){
    	// Get the data again
    	d3.csv("meanAllMonYear.csv", function(error, data) {
       		data.forEach(function(d) {
	    	d.year = +d.year;
	    	d.logYearMeanRate = +d.logYearMeanRate;
	    });

    	// Scale the range of the data again
    	xScale.domain(d3.extent(data, function(d) { return d.year; }));
	 	yScale.domain(d3.extent(data, function(d) { return d.logYearMeanRate; }));

		var valueLine3 = d3.svg.line().interpolate("basis")
			.x(function(d) { return xScale(d.year); })
			.y(function(d) { return yScale(d.logYearMeanRate); });

		var regressionLine3 = d3.svg.line()
    		.x(function(d) { return xScale(d.x); })
    		.y(function(d) { return yScale(d.y); });

		var xval = data.map(function (d) { return d.year; });
		var yval = data.map(function (d) { return d.logYearMeanRate; });


		lr = linearRegression(yval, xval);

		max = d3.max(xval);

		x1= 0;
		x2= max;
		y1= lr.intercept;
		y2= lr.slope*max + lr.intercept;


		var trendData = [{"x": x1, "y": y1}, {"x": x2, "y": y2}];

	// Select the section we want to apply our changes to
		var svg = d3.select("#lineChart").transition();

	// Make the changes
	svg.select(".line")   // change the line
			.duration(750)
			.attr("d", valueLine3(data));
	svg.select("#regressionLine2") //change the regression line
			.duration(750)
			.attr("d", regressionLine3(trendData))
			.attr("id", "regressionLine");
	svg.select(".x.axis") // change the x axis
			.duration(750)
			.call(xAxis);
	svg.select(".y.axis") // change the y axis
			.duration(750)
			.call(yAxis);

    });

	}

</script>
	<script>
	    var margin2 = { top: 20, bottom: 30, left: 40, right: 20 };
	    var width2 = 800 - margin2.left - margin2.right;
	    var height2 = 400 - margin2.top - margin2.bottom;
	    var padding2 = 70;
	    var options = ["Action", "Adventure", "Animation", "Comedy", "Crime", "Drama", "Horror", "Romance", "Thriller", "Documentary"];
	    var prev = "false";
	    var xScale2 = d3.scale.log().range([0, width2]).nice();
	    var yScale2 = d3.scale.log().range([height2, 0]).nice();
	    var colorScale = d3.scale.category10().domain(options);
	    //var colorScale = d3.scale.ordinal().domain(options).range("red","orange","blue","green", "brown", "pink", "purple","pale-green", "lightblue", "gray")
	    var ratedOption = "top50";
	    var chosenGenre = "All";
	    var chosenYear = "All";
	    var chosenRate = "Top-50"
	    var yearArray;
	    var result=[]; var xDomain; var yDomain;
	    var initialData;
	        var xAxis2 = d3.svg.axis().scale(xScale2).orient("bottom").ticks(5).tickFormat(d3.format("s"));
	        var yAxis2 = d3.svg.axis().scale(yScale2).orient("left").ticks(10).tickFormat(d3.format("s"));
	    d3.csv("movie_budgets/movie_budget_all.csv", function(error, data){
	        if(error){
	            throw error;
	        }
	        data = data.filter(function(d) {return (d.imdbRating != "N/A" && d.imdbRating != "None");});
	        result = sortDataByRating(data);
	        initialData = sortDataByRating(data);
	        var ratedOption = "top50";
	        xDomain = d3.extent(initialData[ratedOption], function(d){ return parseInt(d.Budget.substr(1).replace(',', '')); })
	        yDomain = d3.extent(initialData[ratedOption], function(d){ return parseInt(d["Worldwide Gross"].substr(1).replace(',', '')); });
	                displayDataPoints(initialData[ratedOption]);


	    });
	    var svg = d3.select("#scatter-plot")
	        .attr("width", width2+margin2.left+margin2.right)
	        .attr("height", height2+margin2.top+margin2.bottom)
	        .append("g")
	        .attr("transform", "translate("+margin2.left+","+margin2.top+")");


	    function sortDataByRating(values){
	        values.sort(function(a, b){
	            return parseFloat(b.imdbRating) - parseFloat(a.imdbRating);
	        });
	        var filtered = values.filter(function(d){
	            return parseInt(d.Budget.substr(1).replace(',', '')) != 0
	            && parseInt(d["Worldwide Gross"].substr(1).replace(',', '')) !=0;
	        });

	        return { top5: filtered.slice(0, 5), top15: filtered.slice(0, 15), top25: filtered.slice(0, 25), top50: filtered.slice(0, 50), top500: filtered.slice(0,values.length-1) };
	    }


	    function displayDataPoints(data){

	     	document.getElementById("detail").innerHTML = "Click on the circle for more details";
	        d3.selectAll(".axis text").remove();
	        d3.selectAll(".axis line").remove();
	        d3.selectAll(".point").remove();
	        var sizeScale = d3.scale.linear()
	                .domain(d3.extent(data, function(d){ return parseFloat(d.imdbRating); }))
	                .range([5, 18]);


	        xDomain = d3.extent(data, function(d){ return parseInt(d.Budget.substr(1).replace(',', '')); })
	        yDomain = d3.extent(data, function(d){ return parseInt(d["Worldwide Gross"].substr(1).replace(',', '')); });

	        var incrementX = parseInt(xDomain[0]/5);
	        var incrementY = parseInt(yDomain[0]/5);

	        xScale2.domain([xDomain[0]-incrementX, xDomain[1]]);
	        yScale2.domain([yDomain[0]-incrementY, yDomain[1]]);


	      svg.append("g")
	         .attr("class", "axis")
	         .attr("transform", "translate(0,"+height2+")")
	         .call(xAxis)
	         .append("text")
	         .attr("class", "label")
	         .attr("x", width2/2.5)
	         .attr("y", (padding2/2.65))
	         .style("text-anchor", "middle")
	         .style("font-size", "14px")
	         .text("Budget($)");

	      svg.append("g")
	         .attr("class", "axis")
	         .call(yAxis)
	         .append("text")
	         .attr("class", "label")
	         .attr("transform", "rotate(-90)")
	         .attr("x", -width2/3)
	         .attr("y", -padding2/2.5)
	         .style("text-anchor", "middle")
	         .style("font-size", "14px")
	         .text("Worldwide Gross($)");



	      var dataPoints = svg.selectAll(".point")
	            .data(data)
	            .enter()
	            .append("circle")
	            .attr("class", "point")
	            .attr("r", function(d){  return sizeScale(parseFloat(d.imdbRating)); })
	            .attr("cx", xScale2(xDomain[0] - incrementX))
	            .attr("cy", yScale2(yDomain[0] - incrementY))
	            .style("fill", function(d) {

	            if(chosenGenre == "All") {
	                return colorScale(((d.Genre).split(","))[0]);
	            }
	            else {
	                return colorScale(chosenGenre);
	            }
	  } )
	            .style("stroke", "black")
	            .style("opacity", 0.9)
	            .on("click", function(d) {
				if(prev != false)
				{
					d3.select(prev).style("stroke", "black").style("stroke-width2", "1px");
				}
							prev = this;
	            			d3.select(this).style("stroke", "yellow").style("stroke-width2", "5px");

	            	document.getElementById("detail").innerHTML = "<strong>Movie Title:</strong> <span style='color:blue'>" + d.Title +"</span> <br>" + "<strong>Genre:</strong> <span style='color:blue'>" + d.Genre + "</span> <br>"
	                + "<strong>Release Date:</strong> <span style='color:blue'>" + d["Release Date"] + "</span> <br>"
	            	+ "<strong>Budget:</strong> <span style='color:blue'>" + d.Budget + "</span> <br>"
	            	+ "<strong>Worldwide Gross:</strong> <span style='color:blue'>" + d["Worldwide Gross"] + "</span> <br>"
	            	+ "<strong>IMDb Rating:</strong> <span style='color:blue'>" + d.imdbRating + "</span> <br>"
	            	+ "<strong>Awards:</strong> <span style='color:blue'>" + d.Awards + "</span> <br>"
	            	; });

	             dataPoints.transition()
	        .duration(1000)
	        .attr("cx", function(d){ return xScale2(parseInt(d.Budget.substr(1).replace(',', ''))); })
	        .attr("cy", function(d){ return yScale2(parseInt(d["Worldwide Gross"].substr(1).replace(',', ''))); });


	    }



	    function filterDataByGenre(genre, data){
	        return data.filter(function(d){
	            var temp = (d.Genre).split(",");
	            for(var i = 0; i < temp.length; i++) {
	                temp[i]= (temp[i]).trim();
	            }
	            return temp.includes(genre);
	        });
	    }

	    function handleGenreFilterSelection(genre){
	        chosenGenre = genre;
	        document.getElementById('span2').innerHTML="<font color='red'>"+chosenGenre +"</font>" +  " genre";

	        if(chosenYear != "All") {
	            if(chosenGenre == "All") {
	            svg.selectAll(".point").data([]).exit().remove();

	                 displayDataPoints(initialData[ratedOption]);
	            return;
	            }
	            var filteredData = filterDataByGenre(genre, yearArray);
	            var sData = sortDataByRating(filteredData);
	            svg.selectAll(".point").data([]).exit().remove();

	        displayDataPoints(sData[ratedOption])
	            return;
	        }
	        var inputData = initialData["top500"];

	        if(genre == "All") {
	                    svg.selectAll(".point").data([]).exit().remove();

	            displayDataPoints(initialData[ratedOption]);
	            return;
	        }

	        var filteredData = filterDataByGenre(genre, inputData);
	        var sortedData = sortDataByRating(filteredData);
	            svg.selectAll(".point").data([]).exit().remove();

	        displayDataPoints(sortedData[ratedOption]);
	    }


	    function handleYearSelection(value){
	        console.log(value);
	        chosenYear = value;
	                document.getElementById('span3').innerHTML="<font color='red'>"+chosenYear +"</font>"+ " Year";

	        var path = "movie_budgets/movie_budget_" + value + ".csv";
	        d3.csv(path, function(error, data){
	            if(error){
	                throw error;
	            }
	            data = data.filter(function(d) {return (d.imdbRating != "N/A" && d.imdbRating != "None");});

	           var yearData = sortDataByRating(data);
	           yearArray = data;
	            var yData = yearData[ratedOption];
	            svg.selectAll(".point").data([]).exit().remove();

	            if(chosenGenre=="All"){

	                displayDataPoints(yData);
	                return;

	            }
	            yData = yearData["top500"];
	            yearArray = yData;
	            yData = filterDataByGenre(chosenGenre, yData);
	            yData = sortDataByRating(yData);
	            yData = yData[ratedOption];
	            displayDataPoints(yData);
	        });
	    }

	    function handleRating(id, value) {
	        ratedOption = id;
	        chosenRate = value;
	        document.getElementById('span1').innerHTML="<font color='red'>" + chosenRate + "</font>";
	        handleGenreFilterSelection(chosenGenre);

	    }

	document.getElementById('span3').innerHTML="<font color='red'>"+"all" + "</font>" + " years";
	document.getElementById('span2').innerHTML="<font color='red'>"+"all" + "</font>" + " genres";
	document.getElementById('span1').innerHTML="<font color='red'>" + chosenRate + "</font>";

	document.getElementById("label").innerHTML= options[0] + colorScale(0);

	</script>
	<!-- </body>
	</html> -->
 -->
